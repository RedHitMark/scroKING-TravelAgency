<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/png" href="IMG/favicon.png" />
    <link rel="stylesheet" href="CSS/main.css">
    <link rel="stylesheet" href="Font/fontawesome-free-5.10.1-web/css/all.css">
    <title>ScroKING viaggi</title>
</head>

<body>
<div id="header"></div>
<div class="wrapper">
    <section id="serverStatus">
        <div class="row">
            <h1>Server status</h1>
        </div>
        <div class="row">
            <article>
                <p>In questa pagina troverai il riepilogo dei server attivi. Se per qualisiasi motivo i server non funzionano contattaci a info@scroking.com</p>
            </article>
        </div>
        <div id="loading" class="row">
            <article>
                <div class="fa-10x">
                    <i class="fas fa-spinner fa-pulse"></i>
                </div>
            </article>
        </div>
        <div id="server">
            <div class="row">
                <h1>Primary</h1>
            </div>
            <div class="row">
                <article>
                    <div class="col-6">
                        <div class="aboutIMG">
                            <img src="IMG/primary.png" alt="logo">
                        </div>
                    </div>
                    <div class="col-6">
                        <article>
                            <p id="primary-host"></p>
                            <h1>Eletto il</h1>
                            <p id="primary-election-date"></p>
                            <h1>Acceso da</h1>
                            <p id="primary-uptime"></p>
                        </article>
                    </div>
                </article>
            </div>
            <div class="row">
                <h1>Server secondary</h1>
            </div>
            <div class="row">
                <article>
                    <div class="col-6">
                        <table>
                            <tr>
                                <th>Hostname</th>
                                <th>Uptime</th>
                            </tr>
                            <tbody id="secondaryTableBody"></tbody>
                        </table>
                    </div>
                </article>
            </div>

            <div class="row">
                <h1>Server morti</h1>
            </div>
            <div class="row">
                <article>
                    <div class="col-6">
                        <table>
                            <tr>
                                <th>Hostname</th>
                            </tr>
                            <tbody id="mortiTableBody"></tbody>
                        </table>
                    </div>
                </article>
            </div>
        </div>
    </section>
</div>
<div id="footer"></div>
</body>

<script src="JS/jquery.min.js"></script>
<script src="JS/loadheaderfooter.js"></script>
<script src="JS/menu.js"></script>
<script src="JS/http.js"></script>
<script src="JS/time.js"></script>

<script>
    function loadServerInfo() {
        function ok(json_response) {
            let members = json_response.members;
            console.log(members);


            let secondaryHTMLTableBody = "";
            let mortiHTMLTableBody = "";

            $.each(members, function(index, member) {
                let giorni = Math.floor(member.uptime/86400);
                let ore = Math.floor((member.uptime - giorni*86400)/3600);
                let minuti = Math.floor((member.uptime - giorni*86400 - ore*3600)/60);
                let secondi = Math.floor(member.uptime - giorni*86400 - ore*3600 - minuti*60);

                let uptimestring = "".concat(giorni, "giorni,", ore, "ore,", minuti, "minuti,", secondi, "secondi");

                if(member.stateStr === "PRIMARY" ) {
                    $("#primary-host").html(member.name);
                    $("#primary-election-date").html(timestamp2string(member.electionTime.$timestamp.t));
                    $("#primary-uptime").html(uptimestring);
                } else if (member.stateStr === "SECONDARY") {
                    var newSecondary = "<tr><td>"+ member.name + "</td><td>" + uptimestring + "</td></tr>";
                    secondaryHTMLTableBody += newSecondary;
                } else if (member.stateStr === "(not reachable/healthy)") {
                    var newMorto = "<tr><td>"+ member.name + "</td></tr>";
                    mortiHTMLTableBody += newMorto;
                }
            });

            $("#secondaryTableBody").html(secondaryHTMLTableBody);
            $("#mortiTableBody").html(mortiHTMLTableBody);

            //show things
            $("#loading").css({ 'display' : 'none'});
            $("#server").css({ 'display' : 'block'});
        }

        function server_error(json_response) {
            $("#loading").css({ 'display' : 'none'});
            $("#server").css({ 'display' : 'none'});
        }

        const info_functions = {
            200: ok,
            500: server_error
        };

        post("api/server/info.php", null, info_functions);
    }

    loadServerInfo();
    $("#loading").css({ 'display' : 'flex'});
    $("#server").css({ 'display' : 'none'});
</script>

</html>